<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØµÙŠÙ†ÙŠØ© â€” Ù†Ø³Ø®Ø© Ù…ÙØµØ­Ø­Ø©</title>
<style>
  :root{ --bg:#f6f7fb; --card:#fff; --muted:#475569; --ink:#0f172a; --accent:#0ea5a4; --bad:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--ink);-webkit-font-smoothing:antialiased}
  .wrap{max-width:980px;margin:18px auto;padding:14px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:18px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn{cursor:pointer;border-radius:10px;padding:8px 10px;border:1px solid #e6edf0;background:#fff}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .card{background:var(--card);border-radius:12px;padding:14px;margin-top:12px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
  label{display:block;margin:8px 0 4px;color:var(--muted)}
  input[type=text], input[type=date], textarea{width:100%;padding:10px;border:1px solid #e6edf0;border-radius:8px}
  .grid{display:grid;gap:8px}
  .cols-2{grid-template-columns:1fr 1fr}
  .options{display:grid;gap:8px;grid-template-columns:repeat(2,1fr);margin-top:10px}
  .option{padding:12px;border-radius:10px;border:1px solid #eef2f7;background:#fff;cursor:pointer}
  .option.correct{background:#d1fae5;border-color:#10b981}
  .option.wrong{background:#fee2e2;border-color:var(--bad)}
  .sent{padding:10px;border-radius:8px;border:1px solid #eef2f7;background:#fff;margin-top:8px;text-align:right}
  small.muted{color:var(--muted)}
  footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}
  @media (max-width:720px){ .cols-2{grid-template-columns:1fr} .options{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØµÙŠÙ†ÙŠØ© â€” Ù†Ø³Ø®Ø© Ù…ÙØµØ­Ø­Ø©</h1>
      <div class="small muted">ØªØ¯Ø¹Ù…: ØªØ¹Ù„Ù‘Ù… â€” Ù…Ø±Ø§Ø¬Ø¹Ø© â€” ÙƒÙ„Ù…Ø§Øª ØµØ¹Ø¨Ø© â€” Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±</div>
    </div>
    <div class="controls">
      <button class="btn primary" id="nav-dashboard">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="btn" id="nav-add">â• Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø©</button>
      <button class="btn" id="nav-learn">ğŸ“˜ ØªØ¹Ù„Ù‘Ù…</button>
      <button class="btn" id="nav-review">ğŸ“– Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø³ØªØ­Ù‚Ø©</button>
      <button class="btn" id="nav-hard">ğŸ“Œ ÙƒÙ„Ù…Ø§Øª ØµØ¹Ø¨Ø©</button>
      <button class="btn" id="btn-export">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
      <label class="btn" style="cursor:pointer">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯
        <input id="file-import" type="file" accept="application/json" style="display:none">
      </label>
    </div>
  </header>

  <!-- DASHBOARD -->
  <section id="view-dashboard" class="card" style="display:block">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
      <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª:</strong> <span id="stat-count">0</span></div>
      <div><strong>Ù…Ø³ØªØ­Ù‚Ø© Ø§Ù„Ø¢Ù†:</strong> <span id="stat-due">0</span></div>
    </div>
    <div style="margin-top:10px" class="card">
      <input id="q-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨ÙƒÙ„Ù…Ø©/Ù…Ø¹Ù†Ù‰..." type="text">
      <div id="list" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- ADD -->
  <section id="view-add" class="card" style="display:none">
    <h3 style="margin-top:0">Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø©</h3>
    <div class="grid cols-2">
      <div>
        <label>Ø§Ù„ÙƒÙ„Ù…Ø© (æ±‰å­—)</label>
        <input id="f-word" type="text" placeholder="Ù…Ø«Ø§Ù„: ä½ å¥½">
      </div>
      <div>
        <label>Pinyin</label>
        <input id="f-pinyin" type="text" placeholder="Ù…Ø«Ø§Ù„: nÇ hÇo">
      </div>
      <div style="grid-column:1/-1">
        <label>Ø§Ù„Ù…Ø¹Ù†Ù‰ (Ø¹Ø±Ø¨ÙŠ)</label>
        <input id="f-meaning" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±Ø­Ø¨Ù‹Ø§">
      </div>
    </div>

    <h4 style="margin:10px 0 6px 0">Ø«Ù„Ø§Ø« Ø¬Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” ÙƒÙ„ Ø³Ø·Ø±: Ø§Ù„Ø¬Ù…Ù„Ø© / pinyin / Ø§Ù„Ù…Ø¹Ù†Ù‰)</h4>
    <div class="grid">
      <div>
        <label>Ø¬Ù…Ù„Ø© 1</label>
        <input id="s1-text" placeholder="æ±‰å­—">
        <input id="s1-pinyin" placeholder="pinyin">
        <input id="s1-meaning" placeholder="Ø§Ù„Ù…Ø¹Ù†Ù‰">
      </div>
      <div>
        <label>Ø¬Ù…Ù„Ø© 2</label>
        <input id="s2-text" placeholder="æ±‰å­—">
        <input id="s2-pinyin" placeholder="pinyin">
        <input id="s2-meaning" placeholder="Ø§Ù„Ù…Ø¹Ù†Ù‰">
      </div>
      <div>
        <label>Ø¬Ù…Ù„Ø© 3</label>
        <input id="s3-text" placeholder="æ±‰å­—">
        <input id="s3-pinyin" placeholder="pinyin">
        <input id="s3-meaning" placeholder="Ø§Ù„Ù…Ø¹Ù†Ù‰">
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="save-card">Ø­ÙØ¸</button>
      <button class="btn" id="clear-add">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
    </div>
    <small class="muted">* ØªÙÙˆÙ„Ù‘Ø¯ Ø®ÙŠØ§Ø±Ø§Øª Ø®Ø§Ø·Ø¦Ø© Ù…Ù† Ø¨Ø§Ù‚ÙŠ Ù…Ø¹Ø§Ù†ÙŠ Ø¨Ø·Ø§Ù‚Ø§ØªÙƒ.</small>
  </section>

  <!-- LEARN -->
  <section id="view-learn" class="card" style="display:none">
    <h3 style="margin-top:0">ğŸ“˜ ØªØ¹Ù„Ù‘Ù… â€” Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h3>
    <div id="learn-list"></div>
  </section>

  <!-- REVIEW -->
  <section id="view-review" class="card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>ÙˆØ¶Ø¹:</strong> Ù…Ø³ØªØ­Ù‚Ø©</div>
      <div><button class="btn" id="btn-show-answer">ğŸ‘€ ÙƒØ´Ù Ø§Ù„Ù…Ø¹Ù†Ù‰ (ÙŠÙØ¹ØªØ¨Ø± Ø®Ø·Ø£)</button></div>
    </div>
    <div style="text-align:center;margin-top:12px">
      <div style="font-weight:800;font-size:28px" id="q-word">â€”</div>
      <div style="margin-top:8px;color:var(--muted)" id="q-pinyin">â€”</div>
      <div class="options" id="q-options" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- HARD -->
  <section id="view-hard" class="card" style="display:none">
    <h3 style="margin-top:0">ğŸ“Œ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ¹Ø¨Ø©</h3>
    <div id="hard-list"></div>
  </section>

  <footer>ÙŠØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ â€” Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</footer>
</div>

<script>
/* ----------------- Utilities & storage ----------------- */
const STORAGE_KEY = 'zh_flash_v_final';
const LEARN_LAST_ID_KEY = 'zh_flash_learn_last_id'; // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø¢Ø®Ø± Ø¨Ø·Ø§Ù‚Ø© ØªÙˆÙ‚ÙØª Ø¹Ù†Ø¯Ù‡Ø§
const todayYMD = ()=>{ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); };
const addDays = (ymd, days)=>{ const d = new Date(ymd+'T00:00:00'); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); };
const uid = ()=> Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8);
const shuffle = (arr)=>{ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; };

/* ----------------- Default sample (used first-run) ----------------- */
const SAMPLE = [
  { id: uid(), word:"ä½ å¥½", pinyin:"nÇ hÇo", meaning:"Ù…Ø±Ø­Ø¨Ù‹Ø§",
    sentences:[
      {sentence:"ä½ å¥½ï¼", pinyin:"nÇ hÇo!", meaning:"Ù…Ø±Ø­Ø¨Ù‹Ø§!" },
      {sentence:"ä½ å¥½ï¼Œä½ æ€ä¹ˆæ ·ï¼Ÿ", pinyin:"nÇ hÇo, nÇ zÄ›nmeyÃ ng?", meaning:"Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ ÙƒÙŠÙ Ø­Ø§Ù„ÙƒØŸ"},
      {sentence:"å¤§å®¶å¥½ï¼Œæˆ‘å«æé›·ã€‚", pinyin:"dÃ jiÄ hÇo, wÇ’ jiÃ o LÇ LÃ©i.", meaning:"Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¬Ù…ÙŠØ¹Ù‹Ø§ØŒ Ø§Ø³Ù…ÙŠ Ù„ÙŠ Ù„ÙŠ."}
    ], isHard:false, nextReview: todayYMD(), attempts:0, wrongs:0, ivl:1, streak:0, created: todayYMD()
  },
  { id: uid(), word:"è°¢è°¢", pinyin:"xiÃ¨xie", meaning:"Ø´ÙƒØ±Ù‹Ø§",
    sentences:[
      {sentence:"è°¢è°¢ä½ ã€‚", pinyin:"xiÃ¨xie nÇ.", meaning:"Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ."},
      {sentence:"éå¸¸è°¢è°¢ï¼", pinyin:"fÄ“ichÃ¡ng xiÃ¨xie!", meaning:"Ù…Ø´ÙƒÙˆØ± Ø¬Ø¯Ù‹Ø§!"},
      {sentence:"è°¢è°¢ä½ çš„å¸®åŠ©ã€‚", pinyin:"xiÃ¨xie nÇ de bÄngzhÃ¹.", meaning:"Ø´ÙƒØ±Ù‹Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ."}
    ], isHard:false, nextReview: todayYMD(), attempts:0, wrongs:0, ivl:1, streak:0, created: todayYMD()
  }
];

/* ----------------- In-memory state ----------------- */
let CARDS = [];
let SESSION = {queue:[], i:0, mode:'due'}; // queue holds card ids for this session

/* ----------------- Load / Save ----------------- */
function loadAll(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ CARDS = SAMPLE.slice(); saveAll(); return; }
  try{
    const arr = JSON.parse(raw);
    // normalize entries to expected shape
    CARDS = arr.map(c=>{
      // accept older keys (hanzi/word)
      const id = c.id || uid();
      const word = c.word || c.hanzi || c.text || '';
      const pinyin = c.pinyin || '';
      const meaning = c.meaning || c.mean || '';
      // sentences may be array of strings or objects; normalize to objects
      let sentences = [];
      if(Array.isArray(c.sentences)){
        sentences = c.sentences.map(s=>{
          if(!s) return {sentence:'',pinyin:'',meaning:''};
          if(typeof s === 'string') return {sentence:s,pinyin:'',meaning:''};
          return { sentence: s.sentence || s.text || s.hanzi || '', pinyin: s.pinyin || s.py || '', meaning: s.meaning || s.mean || '' };
        });
      } else {
        // try to read s1/s2/s3
        sentences = [
          {sentence: c.s1||'', pinyin:c.s1_pinyin||'', meaning:c.s1_meaning||''},
          {sentence: c.s2||'', pinyin:c.s2_pinyin||'', meaning:c.s2_meaning||''},
          {sentence: c.s3||'', pinyin:c.s3_pinyin||'', meaning:c.s3_meaning||''},
        ];
      }
      // ensure exactly 3 items
      while(sentences.length<3) sentences.push({sentence:'',pinyin:'',meaning:''});
      sentences = sentences.slice(0,3);
      return {
        id, word, pinyin, meaning,
        sentences,
        isHard: !!c.isHard,
        nextReview: c.nextReview || c.due || todayYMD(),
        attempts: c.attempts||0,
        wrongs: c.wrongs||0,
        ivl: c.ivl||1,
        streak: c.streak||0,
        created: c.created || todayYMD()
      };
    });
  }catch(e){
    // if parse fails, reset to sample
    console.warn('loadAll parse error', e);
    CARDS = SAMPLE.slice();
  }
  saveAll(); // ensure normalized version persisted
}
function saveAll(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(CARDS)); refreshDashboard(); }

/* ----------------- UI helpers ----------------- */
const el = {
  dash: document.getElementById('view-dashboard'),
  add: document.getElementById('view-add'),
  learn: document.getElementById('view-learn'),
  review: document.getElementById('view-review'),
  hard: document.getElementById('view-hard'),
  list: document.getElementById('list'),
  statCount: document.getElementById('stat-count'),
  statDue: document.getElementById('stat-due'),
  qWord: document.getElementById('q-word'),
  qPinyin: document.getElementById('q-pinyin'),
  qOptions: document.getElementById('q-options'),
  btnShowAnswer: document.getElementById('btn-show-answer'),
  learnList: document.getElementById('learn-list'),
  hardList: document.getElementById('hard-list')
};

document.getElementById('nav-dashboard').addEventListener('click', ()=> show('dash'));
document.getElementById('nav-add').addEventListener('click', ()=> show('add'));
document.getElementById('nav-learn').addEventListener('click', ()=> show('learn'));
document.getElementById('nav-review').addEventListener('click', ()=> startSession('due'));
document.getElementById('nav-hard').addEventListener('click', ()=> startSession('hard'));
document.getElementById('btn-export').addEventListener('click', exportData);
document.getElementById('file-import').addEventListener('change', importData);

/* ----------------- Show view ----------------- */
function show(name){
  // hide all then show target
  ['view-dashboard','view-add','view-learn','view-review','view-hard'].forEach(id=>document.getElementById(id).style.display='none');
  if(name==='dash') document.getElementById('view-dashboard').style.display='';
  if(name==='add') document.getElementById('view-add').style.display='';
  if(name==='learn'){ document.getElementById('view-learn').style.display=''; renderLearn(); }
  if(name==='review') document.getElementById('view-review').style.display='';
  if(name==='hard'){ document.getElementById('view-hard').style.display=''; renderHardList(); }
  refreshDashboard();
}

/* ----------------- Dashboard / List ----------------- */
function refreshDashboard(){
  el.statCount.textContent = CARDS.length;
  el.statDue.textContent = CARDS.filter(c => new Date(c.nextReview) <= new Date()).length;
  // list items
  const q = (document.getElementById('q-search').value||'').trim().toLowerCase();
  const items = q ? CARDS.filter(c=> (c.word||'').toLowerCase().includes(q) || (c.meaning||'').toLowerCase().includes(q) || (c.pinyin||'').toLowerCase().includes(q) ) : CARDS;
  el.list.innerHTML = '';
  if(items.length===0){ el.list.innerHTML = '<div class="small muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª.</div>'; return; }
  items.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'card';
    const diffPct = c.attempts>0 ? Math.round((c.wrongs/c.attempts)*100) : 0;
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div>
          <div style="font-weight:800;font-size:18px">${escapeText(c.word)}</div>
          <div style="color:var(--muted);font-size:13px;margin-top:6px">
            ${escapeText(c.pinyin)} â€” ${escapeText(c.meaning)}
            <span style="margin-left:8px">âœª ${diffPct}%</span>
            <span style="margin-left:8px">ğŸ“… ${escapeText(c.nextReview)}</span>
            <span style="margin-left:8px">â— ${c.isHard? 'Ù†Ø¹Ù…':'Ù„Ø§'}</span>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" data-pron>ğŸ”Š</button>
          <button class="btn" data-review>Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
          <button class="btn" data-edit>âœï¸</button>
          <button class="btn" data-del style="color:var(--bad)">Ø­Ø°Ù</button>
        </div>
      </div>
    `;
    el.list.appendChild(div);

    div.querySelector('[data-pron]').addEventListener('click', ()=> speak(c.word));
    div.querySelector('[data-review]').addEventListener('click', ()=> {
      // single-card review session
      SESSION.mode='single';
      SESSION.queue = [c.id];
      SESSION.i = 0;
      show('review'); renderReviewCard();
    });
    div.querySelector('[data-del]').addEventListener('click', ()=> {
      if(confirm('Ø­Ø°Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ')){ CARDS = CARDS.filter(x=>x.id!==c.id); saveAll(); }
    });
    div.querySelector('[data-edit]').addEventListener('click', ()=> {
      // simple edit via prompt (quick)
      const newWord = prompt('Ø§Ù„ÙƒÙ„Ù…Ø© (æ¼¢å­—):', c.word)||c.word;
      const newPin = prompt('Pinyin:', c.pinyin||'')||'';
      const newMeaning = prompt('Ø§Ù„Ù…Ø¹Ù†Ù‰:', c.meaning||'')||'';
      c.word = newWord.trim(); c.pinyin = newPin.trim(); c.meaning = newMeaning.trim();
      saveAll();
    });
  });
}
document.getElementById('q-search').addEventListener('input', refreshDashboard);

/* ----------------- Text escaping to avoid injection ----------------- */
function escapeText(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ----------------- TTS (simple) ----------------- */
function speak(text){
  if(!text) return;
  if(!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'zh-CN';
  const v = window.speechSynthesis.getVoices().find(x=>x.lang && x.lang.toLowerCase().startsWith('zh'));
  if(v) u.voice = v;
  window.speechSynthesis.speak(u);
}

/* ----------------- Add Card (form) ----------------- */
document.getElementById('save-card').addEventListener('click', ()=>{
  const word = document.getElementById('f-word').value.trim();
  const pinyin = document.getElementById('f-pinyin').value.trim();
  const meaning = document.getElementById('f-meaning').value.trim();
  if(!word || !meaning){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ„Ù…Ø© ÙˆØ§Ù„Ù…Ø¹Ù†Ù‰ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
  const s1 = { sentence: document.getElementById('s1-text').value.trim(), pinyin: document.getElementById('s1-pinyin').value.trim(), meaning: document.getElementById('s1-meaning').value.trim() };
  const s2 = { sentence: document.getElementById('s2-text').value.trim(), pinyin: document.getElementById('s2-pinyin').value.trim(), meaning: document.getElementById('s2-meaning').value.trim() };
  const s3 = { sentence: document.getElementById('s3-text').value.trim(), pinyin: document.getElementById('s3-pinyin').value.trim(), meaning: document.getElementById('s3-meaning').value.trim() };
  const sentences = [s1,s2,s3].map(x=>({ sentence: x.sentence||'', pinyin: x.pinyin||'', meaning: x.meaning||'' }));
  const card = {
    id: uid(), word, pinyin, meaning, sentences,
    isHard:false, nextReview: todayYMD(), attempts:0, wrongs:0, ivl:1, streak:0, created:todayYMD()
  };
  CARDS.unshift(card);
  saveAll();
  // clear
  ['f-word','f-pinyin','f-meaning','s1-text','s1-pinyin','s1-meaning','s2-text','s2-pinyin','s2-meaning','s3-text','s3-pinyin','s3-meaning'].forEach(id=>document.getElementById(id).value='');
  show('dash');
});
document.getElementById('clear-add').addEventListener('click', ()=> {
  ['f-word','f-pinyin','f-meaning','s1-text','s1-pinyin','s1-meaning','s2-text','s2-pinyin','s2-meaning','s3-text','s3-pinyin','s3-meaning'].forEach(id=>document.getElementById(id).value='');
});

/* ----------------- Build options (safe) ----------------- */
function buildOptionsFor(cardId){
  const card = CARDS.find(c=>c.id===cardId);
  if(!card) return [ 'â€”' ];
  // collect other meanings
  const others = shuffle(CARDS.filter(c=>c.id!==cardId && c.meaning).map(c=>c.meaning));
  const wrongs = others.slice(0,5);
  while(wrongs.length<5) wrongs.push('â€”');
  return shuffle([card.meaning, ...wrongs]);
}

/* ----------------- Session logic (review) ----------------- */
function startSession(mode){
  SESSION.mode = mode;
  SESSION.i = 0;
  let pool = [];
  if(mode==='due'){
    pool = CARDS.filter(c=> new Date(c.nextReview) <= new Date() ).map(c=>c.id);
    if(pool.length===0){ alert('Ù„Ø§ Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø³ØªØ­Ù‚Ø© Ø§Ù„Ø¢Ù†.'); show('dash'); return; }
  } else if(mode==='hard'){
    pool = CARDS.filter(c=> c.isHard ).map(c=>c.id);
    if(pool.length===0){ alert('Ù„Ø§ ÙƒÙ„Ù…Ø§Øª ØµØ¹Ø¨Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.'); show('dash'); return; }
  } else if(mode==='single'){
    // should be prepared externally
  }
  // randomize and set queue
  SESSION.queue = shuffle(pool);
  show('review');
  renderReviewCard();
}

/* render current review card (word-only + options) */
function renderReviewCard(){
  el.qOptions.innerHTML = '';
  el.qWord.textContent = 'â€”'; el.qPinyin.textContent = 'â€”';
  if(SESSION.i >= SESSION.queue.length){
    // session finished
    alert('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© âœ…');
    show('dash');
    return;
  }
  const cid = SESSION.queue[SESSION.i];
  const card = CARDS.find(c=>c.id===cid);
  if(!card){ SESSION.i++; renderReviewCard(); return; }
  el.qWord.textContent = card.word;
  el.qPinyin.textContent = card.pinyin || 'â€”';
  const opts = buildOptionsFor(card.id); // array of 6 strings
  opts.forEach(opt=>{
    const b = document.createElement('button');
    b.className = 'option';
    b.type = 'button';
    b.textContent = opt;
    b.addEventListener('click', ()=> {
      handleAnswer(card.id, opt, b);
    });
    el.qOptions.appendChild(b);
  });
}

/* handle answer selection */
function handleAnswer(cardId, chosenText, btnElement){
  const card = CARDS.find(c=>c.id===cardId);
  if(!card) return;
  // prevent double clicks by disabling options
  [...el.qOptions.querySelectorAll('button')].forEach(b=>b.disabled = true);
  card.attempts = (card.attempts||0) + 1;
  const correct = (chosenText === card.meaning);
  if(correct){
    btnElement.classList.add('correct');
    // scheduling rule
    card.streak = (card.streak||0) + 1;
    if(card.streak===1) card.ivl = 1;
    else if(card.streak===2) card.ivl = 2;
    else card.ivl = Math.max(3, Math.ceil((card.ivl||1)*1.7));
    card.nextReview = addDays(todayYMD(), card.ivl);
  } else {
    btnElement.classList.add('wrong');
    card.wrongs = (card.wrongs||0) + 1;
    card.streak = 0;
    card.ivl = 1;
    card.nextReview = addDays(todayYMD(), 1);
    card.isHard = true; // immediately mark as hard
  }
  saveAll();
  // move to next card (do NOT reinsert in this session)
  setTimeout(()=>{
    SESSION.i++;
    if(SESSION.i < SESSION.queue.length) renderReviewCard();
    else { alert('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© âœ…'); show('dash'); }
  }, 550);
}

/* Show answer (considered a mistake) */
el.btnShowAnswer.addEventListener('click', ()=> {
  if(SESSION.i >= SESSION.queue.length) return;
  const cid = SESSION.queue[SESSION.i];
  const card = CARDS.find(c=>c.id===cid);
  if(!card) return;
  // mark as wrong
  card.attempts = (card.attempts||0)+1;
  card.wrongs = (card.wrongs||0)+1;
  card.streak = 0;
  card.ivl = 1;
  card.nextReview = addDays(todayYMD(), 1);
  card.isHard = true;
  saveAll();
  // reveal correct option visually
  [...el.qOptions.querySelectorAll('button')].forEach(b=>{
    if(b.textContent === card.meaning) b.classList.add('correct');
    b.disabled = true;
  });
  setTimeout(()=>{ SESSION.i++; if(SESSION.i < SESSION.queue.length) renderReviewCard(); else { alert('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© âœ…'); show('dash'); } }, 700);
});

/* ----------------- Learn (single card view with navigation) ----------------- */
/* We store last seen card by its id (more robust than by index) */
function getLearnIndex(){
  if(CARDS.length === 0) return 0;
  const lastId = localStorage.getItem(LEARN_LAST_ID_KEY);
  if(lastId){
    const idx = CARDS.findIndex(c=>c.id === lastId);
    if(idx !== -1) return idx;
  }
  // default to 0
  return 0;
}
function setLearnIndex(i){
  if(i < 0) i = 0;
  if(i >= CARDS.length) i = CARDS.length - 1;
  const c = CARDS[i];
  if(c && c.id) localStorage.setItem(LEARN_LAST_ID_KEY, c.id);
}

function renderLearn(){
  el.learnList.innerHTML = '';
  if(CARDS.length===0){ el.learnList.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨Ø¹Ø¯.'; return; }

  let idx = getLearnIndex();
  if(idx < 0) idx = 0;
  if(idx >= CARDS.length) idx = CARDS.length - 1;
  // ensure stored id stays consistent
  setLearnIndex(idx);

  const c = CARDS[idx];
  if(!c){ el.learnList.textContent = 'Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.'; return; }

  const d = document.createElement('div');
  d.className = 'card';

  // Header (word + pinyin + meaning + speak)
  const header = document.createElement('div');
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.innerHTML = `
    <div>
      <div style="font-weight:800;font-size:20px">${escapeText(c.word)}</div>
      <div style="color:var(--muted)">${escapeText(c.pinyin)} â€” ${escapeText(c.meaning)}</div>
    </div>
  `;
  const speakBtn = document.createElement('button');
  speakBtn.className = 'btn';
  speakBtn.textContent = "ğŸ”Š";
  speakBtn.addEventListener('click', ()=> speak(c.word));
  header.appendChild(speakBtn);
  d.appendChild(header);

  // Counter (Ø¨Ø·Ø§Ù‚Ø© X Ù…Ù† Y)
  const counter = document.createElement('div');
  counter.style.marginTop = '8px';
  counter.style.color = 'var(--muted)';
  counter.style.fontSize = '13px';
  counter.textContent = `Ø¨Ø·Ø§Ù‚Ø© ${idx+1} Ù…Ù† ${CARDS.length}`;
  d.appendChild(counter);

  // Three sentences
  c.sentences.forEach((s,si)=>{
    const sdiv = document.createElement('div');
    sdiv.className = 'sent';
    sdiv.innerHTML = `
      <div style="font-weight:700">Ø¬Ù…Ù„Ø© ${si+1}</div>
      <div style="font-size:16px">${escapeText(s.sentence||'â€”')}</div>
      <div style="color:var(--muted)">${escapeText(s.pinyin||'â€”')}</div>
      <div style="color:var(--accent)">${escapeText(s.meaning||'â€”')}</div>
    `;
    d.appendChild(sdiv);
  });

  // Navigation buttons
  const nav = document.createElement('div');
  nav.style.display = 'flex';
  nav.style.justifyContent = 'space-between';
  nav.style.marginTop = '10px';

  const prevBtn = document.createElement('button');
  prevBtn.className = 'btn';
  prevBtn.textContent = 'â®ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚';
  prevBtn.disabled = (idx === 0);
  prevBtn.addEventListener('click', ()=>{
    if(idx > 0){
      const newIdx = idx - 1;
      setLearnIndex(newIdx);
      renderLearn();
    }
  });

  const nextBtn = document.createElement('button');
  nextBtn.className = 'btn';
  nextBtn.textContent = 'â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ';
  nextBtn.disabled = (idx >= CARDS.length - 1);
  nextBtn.addEventListener('click', ()=>{
    if(idx < CARDS.length - 1){
      const newIdx = idx + 1;
      setLearnIndex(newIdx);
      renderLearn();
    }
  });

  nav.appendChild(prevBtn);
  nav.appendChild(nextBtn);
  d.appendChild(nav);

  el.learnList.appendChild(d);
}

/* ----------------- Hard words list and review ----------------- */
function renderHardList(){
  el.hardList.innerHTML = '';
  const hard = CARDS.filter(c=>c.isHard);
  if(hard.length===0){ el.hardList.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª ØµØ¹Ø¨Ø©.'; return; }
  hard.forEach(card=>{
    const d = document.createElement('div'); d.className='card';
    d.innerHTML = `<div style="font-weight:800;font-size:18px">${escapeText(card.word)}</div>
      <div style="color:var(--muted)">${escapeText(card.pinyin)} â€” ${escapeText(card.meaning)}</div>`;
    const btns = document.createElement('div'); btns.style.marginTop='8px';
    const startBtn = document.createElement('button'); startBtn.className='btn'; startBtn.textContent='Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø©';
    startBtn.addEventListener('click', ()=> {
      // single card review
      SESSION.mode='single';
      SESSION.queue = [card.id]; SESSION.i=0;
      show('review'); renderReviewCard();
    });
    const clearBtn = document.createElement('button'); clearBtn.className='btn'; clearBtn.textContent='Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„ØµØ¹Ø¨Ø©';
    clearBtn.addEventListener('click', ()=> { card.isHard = false; saveAll(); renderHardList(); });
    btns.appendChild(startBtn); btns.appendChild(clearBtn);
    d.appendChild(btns);
    el.hardList.appendChild(d);
  });
}

/* ----------------- Export / Import ----------------- */
function exportData(){
  const dataStr = JSON.stringify(CARDS, null, 2);
  const blob = new Blob([dataStr], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'cards-export.json';
  a.click();
}

function importData(evt){
  const f = evt.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const arr = JSON.parse(e.target.result);
      if(!Array.isArray(arr)) throw new Error('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
      // sanitize and merge (avoid exact id conflict: if id exists, generate new id)
      const existingIds = new Set(CARDS.map(c=>c.id));
      const newCards = arr.map(item=>{
        const id = (item.id && !existingIds.has(item.id)) ? item.id : uid();
        existingIds.add(id);
        // normalize similar to loadAll
        const word = item.word || item.hanzi || '';
        const pinyin = item.pinyin || '';
        const meaning = item.meaning || '';
        let sentences = [];
        if(Array.isArray(item.sentences)) sentences = item.sentences.map(s=> typeof s==='string' ? {sentence:s,pinyin:'',meaning:''} : {sentence:s.sentence||'', pinyin:s.pinyin||'', meaning:s.meaning||''} ).slice(0,3);
        while(sentences.length<3) sentences.push({sentence:'',pinyin:'',meaning:''});
        return { id, word, pinyin, meaning, sentences, isHard: !!item.isHard, nextReview: item.nextReview||todayYMD(), attempts:item.attempts||0, wrongs:item.wrongs||0, ivl:item.ivl||1, streak:item.streak||0, created:item.created||todayYMD() };
      });
      CARDS = newCards.concat(CARDS);
      saveAll();
      alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…');
    }catch(err){
      alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ â€” Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
      console.error(err);
    } finally {
      // clear file input so same file can be re-imported if needed
      evt.target.value = '';
    }
  };
  reader.readAsText(f);
}

/* ----------------- Init ----------------- */
loadAll();
show('dash');

/* expose for debugging (optional) */
window._CARDS = CARDS;
</script>
</body>
</html>
